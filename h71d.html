<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Commission Quick Viewer v4.1 (H71D & B8BL)</title>
    
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        if (typeof XLSX === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');
        }
    </script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-app: #f3f4f6;
            --bg-sidebar: #111827;
            --text-sidebar: #e5e7eb;
            --white: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --sidebar-width: 280px;
            
            /* H71D Specific Colors */
            --hkg-tag-bg: #ede9fe; /* Light Violet */
            --hkg-tag-text: #7c3aed;
            --soto-tag-bg: #fce7f3; /* Light Pink */
            --soto-tag-text: #db2777;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-app); color: var(--text-main); height: 100vh; overflow: hidden; }

        .app-container { display: flex; height: 100%; width: 100%; position: relative; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); color: var(--text-sidebar); display: flex; flex-direction: column; padding: 1.25rem; flex-shrink: 0; border-right: 1px solid #374151; }
        .brand { margin-bottom: 2rem; display: flex; align-items: center; justify-content: space-between; }
        .brand h2 { margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--white); }
        .badge { background: var(--success); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        
        .badge-type { font-size: 0.6rem; padding: 2px 4px; border-radius: 3px; margin-left: 6px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); }
        .badge-type.B8BL { color: #60a5fa; border-color: #60a5fa; }
        .badge-type.H71D { color: #c084fc; border-color: #c084fc; }

        .sidebar-section { margin-bottom: 2rem; flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .sidebar h3 { font-size: 0.8rem; text-transform: uppercase; color: #9ca3af; margin: 0; letter-spacing: 0.05em; }
        .btn-icon { background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 1.2rem; padding: 0; }
        .btn-icon:hover { color: var(--white); }

        .file-input-wrapper { margin-bottom: 1rem; }
        .pcc-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .pcc-item { padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; background: #1f2937; cursor: pointer; transition: all 0.2s; position: relative; border-left: 3px solid transparent; }
        .pcc-item:hover { background: #374151; }
        .pcc-item.active { background: #374151; border-left-color: var(--primary); }
        .pcc-info { display: flex; justify-content: space-between; align-items: baseline; }
        .pcc-name { font-weight: bold; font-size: 1rem; color: var(--white); }
        .pcc-date { font-size: 0.75rem; color: #9ca3af; }
        .pcc-stats { font-size: 0.75rem; color: #9ca3af; margin-top: 4px; display: flex; gap: 8px; align-items: center; }
        .btn-delete-pcc { position: absolute; right: 8px; top: 8px; background: none; border: none; color: #6b7280; cursor: pointer; font-size: 1.1rem; padding: 0 4px; display: none; }
        .pcc-item:hover .btn-delete-pcc { display: block; color: var(--danger); }

        .sidebar-section.bottom { flex: 0; margin-bottom: 0; border-top: 1px solid #374151; padding-top: 1.5rem; }
        .app-version { font-size: 0.7rem; color: #4b5563; text-align: center; margin-top: 1rem; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; background: #f9fafb; }

        /* Search Header */
        .search-header { background: var(--white); padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 10; }
        .search-row { display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 0.75rem; }
        .search-row.secondary { margin-bottom: 0; align-items: center; justify-content: space-between; }

        .flex-1 { flex: 1; }
        .flex-2 { flex: 2; }

        .input-group label { display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.35rem; color: var(--text-sub); text-transform: uppercase; }
        .input-group input { width: 100%; padding: 0.6rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem; transition: border 0.2s; }
        .input-group input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        
        /* Mode Specific Visibility */
        body:not(.mode-h71d) .h71d-only { display: none !important; }
        body.mode-h71d .b8bl-only { display: none !important; }

        .advanced-details { flex: 1; }
        .advanced-details summary { cursor: pointer; font-size: 0.85rem; color: var(--primary); font-weight: 500; user-select: none; }
        .advanced-filters { display: flex; gap: 1rem; margin-top: 0.75rem; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; flex-wrap: wrap; }
        .advanced-filters input { flex: 1; min-width: 120px; padding: 0.4rem; font-size: 0.85rem; }

        .toggle-group { display: flex; align-items: center; gap: 1.5rem; }
        .switch-label { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer; user-select: none; }
        .btn-text { background: none; border: none; color: var(--text-sub); text-decoration: underline; cursor: pointer; font-size: 0.85rem; }

        /* Buttons */
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3); }
        .btn-block { width: 100%; }
        .btn-sm { padding: 0.35rem 0.75rem; font-size: 0.8rem; }
        .btn-outline { background: transparent; border: 1px solid #4b5563; color: var(--text-sidebar); }
        .btn-outline:hover { border-color: var(--white); color: var(--white); }
        .btn-lg { height: 42px; padding: 0 1.5rem; }
        
        .btn-detail-hl { 
            background: linear-gradient(135deg, #f97316, #ea580c); 
            color: #ffffff !important; 
            font-weight: 800; 
            font-size: 0.9rem;
            border: none; 
            box-shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.4);
            transition: all 0.2s ease-in-out;
            padding: 0.45rem 1.2rem;
            letter-spacing: 0.02em;
        }
        .btn-detail-hl:hover { background: linear-gradient(135deg, #ea580c, #c2410c); transform: translateY(-1px); }

        /* Results */
        .results-info { padding: 0.5rem 1.5rem; background: #eefff6; color: #065f46; font-size: 0.85rem; border-bottom: 1px solid #d1fae5; }
        .results-grid { padding: 1.5rem; overflow-y: auto; flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1rem; align-content: start; }

        .card { background: var(--white); border: 1px solid #e5e7eb; border-radius: 8px; padding: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; flex-direction: column; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .card-header { padding: 1rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: flex-start; background: #fff; border-radius: 8px 8px 0 0; }
        .card-airline { font-weight: 800; font-size: 1.15rem; color: var(--text-main); line-height: 1.3; display: block; }
        .card-pcc-tag { font-size: 0.7rem; background: #e5e7eb; padding: 2px 6px; border-radius: 4px; vertical-align: middle; color: #4b5563; font-weight: normal; margin-top: 4px; display: inline-block; }
        .card-body { padding: 1rem; flex: 1; font-size: 0.9rem; }
        .card-footer { padding: 0.75rem 1rem; background: #f9fafb; border-top: 1px solid #e5e7eb; border-radius: 0 0 8px 8px; display: flex; gap: 0.75rem; align-items: center; }

        /* H71D Card Styles */
        .h71d-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; margin-left: 8px; display: inline-block; }
        .tag-hkg { background-color: var(--hkg-tag-bg); color: var(--hkg-tag-text); border: 1px solid var(--hkg-tag-text); }
        .tag-soto { background-color: var(--soto-tag-bg); color: var(--soto-tag-text); border: 1px solid var(--soto-tag-text); }
        
        .h71d-content-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem; }
        .h71d-content-text { font-family: monospace; font-size: 0.85rem; color: #334155; white-space: pre-wrap; line-height: 1.4; }
        .h71d-extra { margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed #cbd5e1; font-size: 0.8rem; color: #d97706; }
        
        .h71d-comm-row { display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; }
        .h71d-fee-pill { background: #d1fae5; color: #047857; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; border: 1px solid #10b981; }

        /* B8BL Card Styles */
        .data-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: baseline; gap: 1rem; }
        .data-label { color: var(--text-sub); font-size: 0.8rem; flex: 1; }
        .data-value { font-weight: 500; text-align: right; flex: 2; word-break: break-word; }
        .value-highlight { color: var(--primary); font-weight: 600; }
        .commission-box { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .comm-label { font-size: 0.8rem; font-weight: 600; color: var(--text-sub); text-transform: uppercase; }
        .comm-value { font-size: 1.4rem; font-weight: 800; color: var(--success); }

        /* Slide Panel */
        .slide-panel { position: absolute; top: 0; right: 0; bottom: 0; width: 100%; max-width: 600px; background: var(--white); box-shadow: -10px 0 25px rgba(0,0,0,0.15); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 100; display: flex; flex-direction: column; }
        .slide-panel.wide { max-width: 900px; }
        .slide-panel.open { transform: translateX(0); }
        .panel-header { padding: 1.25rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #f9fafb; }
        .panel-header h2 { margin: 0; font-size: 1.25rem; }
        .btn-close { background: none; border: none; font-size: 1.75rem; cursor: pointer; color: var(--text-sub); line-height: 1; padding: 0.5rem; }
        .panel-content { padding: 1.5rem; overflow-y: auto; flex: 1; }

        /* Tables & Notes */
        .detail-section { margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 6px; overflow-x: auto; }
        .section-title { background: #f3f4f6; padding: 0.75rem 1rem; margin: 0; font-size: 0.95rem; font-weight: 700; color: var(--text-main); border-bottom: 1px solid #e5e7eb; display:flex; justify-content: space-between; align-items: center; }
        .info-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 500px; }
        .info-table th { background: #f9fafb; text-align: left; padding: 0.6rem 1rem; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--text-sub); white-space: nowrap; }
        .info-table td { padding: 0.6rem 1rem; border-bottom: 1px solid #e5e7eb; color: var(--text-main); vertical-align: top; }
        
        .notes-section { background: #fffbeb; border: 1px solid #fcd34d; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; }
        .dual-input { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .notes-section textarea { width: 100%; height: 80px; border: 1px solid #fcd34d; border-radius: 4px; padding: 0.5rem; font-family: monospace; font-size: 0.85rem; resize: vertical; }

        /* Canvas */
        .canvas-wrapper { border: 1px solid #e5e7eb; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 1.5rem; padding: 1rem; background: #555; display: flex; justify-content: center; overflow-x: auto; }
        #previewCanvas { max-width: 100%; height: auto; background: white; min-width: 600px; }

        .empty-state { text-align: center; margin-top: 4rem; color: var(--text-sub); }
        .empty-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 50; backdrop-filter: blur(2px); display: none; }
        .overlay.open { display: block; }
        
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #374151; padding: 1rem; max-height: 250px; }
            .search-row.primary { flex-direction: column; align-items: stretch; gap: 0.5rem; }
            .dual-input { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <aside class="sidebar">
            <div class="brand">
                <h2>Commission v4.1</h2>
                <span class="badge">Global</span>
            </div>
            
            <div class="sidebar-section">
                <div class="section-header">
                    <h3>Datasets</h3>
                    <button id="btnRefreshDB" class="btn-icon" title="Refresh">‚Üª</button>
                </div>
                <div class="file-input-wrapper">
                    <label for="uploadExcel" class="btn btn-primary btn-block">
                        <span class="icon">+</span> Upload B8BL / H71D
                    </label>
                    <input type="file" id="uploadExcel" accept=".xlsx, .xls" hidden>
                </div>
                <ul id="pccList" class="pcc-list">
                    <li class="loading-text" style="color:#aaa; text-align:center;">Initializing...</li>
                </ul>
            </div>
            
            <div class="sidebar-section bottom">
                <div class="btn-group" style="display:flex; gap:0.5rem;">
                    <button id="btnExportData" class="btn btn-sm btn-outline">Export</button>
                    <button id="btnImportData" class="btn btn-sm btn-outline">Import</button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="search-header">
                <div class="search-row primary">
                    <div class="input-group flex-2">
                        <label id="lblAirline">Airline / Ëà™Âè∏ / ÂÖ≥ÈîÆÂ≠ó</label>
                        <input type="text" id="inpAirline" placeholder="Enter Code (e.g. UA) or Keywords...">
                    </div>
                    <div class="input-group flex-1 b8bl-only">
                        <label>Origin</label>
                        <input type="text" id="inpOrigin" placeholder="YYZ, CA...">
                    </div>
                    <div class="input-group flex-1 b8bl-only">
                        <label>Dest</label>
                        <input type="text" id="inpDest" placeholder="LHR, GB...">
                    </div>
                    <div class="input-group action">
                        <button id="btnSearch" class="btn btn-primary btn-lg">Search / Êü•ËØ¢</button>
                    </div>
                </div>
                
                <div class="search-row secondary">
                    <div class="b8bl-only" style="flex:1;">
                        <details class="advanced-details">
                            <summary>Filters (Cabin, Tour Code...)</summary>
                            <div class="advanced-filters">
                                <input type="text" id="inpCabin" placeholder="Cabin">
                                <input type="text" id="inpRBD" placeholder="RBD">
                                <input type="text" id="inpTourCode" placeholder="Tour Code">
                                <input type="text" id="inpFareClass" placeholder="Fare Class">
                            </div>
                        </details>
                    </div>
                    <div class="h71d-only" style="flex:1; color:#6b7280; font-size:0.85rem; font-style:italic;">
                        <span class="icon">‚ÑπÔ∏è</span> H71D Mode: Full text search enabled (e.g. "TFU", "Student")
                    </div>
                    <div class="toggle-group">
                        <label class="switch-label">
                            <input type="checkbox" id="chkCurrentPCC" checked> 
                            <span>Current DB Only</span>
                        </label>
                    </div>
                </div>
            </header>

            <div id="resultsHeader" class="results-info hidden">
                Found <span id="resCount">0</span> rules.
            </div>
            <div id="resultsArea" class="results-grid">
                <div class="empty-state">
                    <div class="empty-icon">üìÇ</div>
                    <h3>Ready</h3>
                    <p>Select a dataset or upload a file to begin.</p>
                </div>
            </div>
        </main>

        <!-- Slide Panel -->
        <div id="detailPanel" class="slide-panel">
            <div class="panel-header">
                <h2 id="panelTitle">Details</h2>
                <button class="btn-close" onclick="closePanel('detailPanel')">&times;</button>
            </div>
            <div class="panel-content">
                <div class="notes-section">
                    <h4><span class="icon">‚úé</span> Agency Notes / Êìç‰ΩúÂ§áÊ≥®</h4>
                    <div class="dual-input">
                        <textarea id="noteEn" placeholder="Notes (EN)"></textarea>
                        <textarea id="noteCn" placeholder="Â§áÊ≥® (‰∏≠Êñá)"></textarea>
                    </div>
                    <div class="notes-actions">
                        <span id="noteSaveStatus" class="status-text"></span>
                        <button id="btnSaveNotes" class="btn btn-sm btn-primary">Save</button>
                    </div>
                </div>
                <div id="panelBody" class="detail-body"></div>
            </div>
        </div>
        
        <!-- Canvas Panel -->
        <div id="canvasPanel" class="slide-panel wide">
            <div class="panel-header">
                <h2>Checklist</h2>
                <button class="btn-close" onclick="closePanel('canvasPanel')">&times;</button>
            </div>
            <div class="panel-content center-content">
                <div class="canvas-wrapper">
                    <canvas id="previewCanvas"></canvas>
                </div>
                <div class="action-bar" style="text-align:center;">
                    <button id="btnDownloadCanvas" class="btn btn-primary">Download Image</button>
                </div>
            </div>
        </div>

        <div id="overlay" class="overlay" onclick="closeAllPanels()"></div>
    </div>

    <script>
        const DB_NAME='CommissionViewerV4_1'; const DB_VERSION=1;
        const AIRLINE_CN_MAP = {
            "3U":"Sichuan AirlinesÂõõÂ∑ùËà™Á©∫", "8M":"Myanmar Airways", "AC":"Air CanadaÂä†ÊãøÂ§ßËà™Á©∫",
            "CI":"China Airlines‰∏≠ÂçéËà™Á©∫", "CX":"Cathay PacificÂõΩÊ≥∞Ëà™Á©∫", "CZ":"China SouthernÂçóÊñπËà™Á©∫",
            "EK":"EmiratesÈòøËÅîÈÖãËà™Á©∫", "ET":"Ethiopian Airlines", "HU":"Hainan AirlinesÊµ∑ÂçóËà™Á©∫",
            "JL":"Japan AirlinesÊó•Êú¨Ëà™Á©∫", "KE":"Korean AirÂ§ßÈü©Ëà™Á©∫", "MH":"Malaysia Airlines",
            "MU":"China Eastern‰∏úÊñπËà™Á©∫", "NH":"ANAÂÖ®Êó•Á©∫", "NZ":"Air New Zealand",
            "OZ":"Asiana AirlinesÈü©‰∫öËà™Á©∫", "PR":"Philippine Airlines", "QF":"Qantas",
            "QR":"Qatar Airways", "SQ":"Singapore Airlines", "TK":"Turkish Airlines",
            "UA":"United AirlinesÁæéËÅîËà™", "VS":"Virgin Atlantic", "WS":"WestJet", "YP":"Air Premia"
        };

        let db;
        let state = { currentPCC:null, currentType:'B8BL', allDatasets:[], masterData:[], h71dData:[], summaryData:[], detailsMap:{}, airlineCodeMap:{} };

        function initDB() {
            return new Promise((resolve,reject)=>{
                const req=indexedDB.open(DB_NAME,DB_VERSION);
                req.onupgradeneeded=(e)=>{
                    db=e.target.result;
                    if(!db.objectStoreNames.contains('datasets')) db.createObjectStore('datasets',{keyPath:'id'});
                    if(!db.objectStoreNames.contains('notes')) db.createObjectStore('notes',{keyPath:'id'});
                };
                req.onsuccess=(e)=>{db=e.target.result; resolve(db);};
                req.onerror=(e)=>reject(e);
            });
        }

        // --- Parser Logic ---
        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Smart Type Detection
                        const firstSheetName = workbook.SheetNames[0];
                        const ws = workbook.Sheets[firstSheetName];
                        
                        // Check first 10 rows for signature columns
                        let isH71D = false;
                        const range = XLSX.utils.decode_range(ws['!ref'] || "A1:G10");
                        for (let R = 0; R <= Math.min(range.e.r, 10); ++R) {
                            const rowText = [];
                            for(let C=0; C<=range.e.c; ++C) {
                                const cell = ws[XLSX.utils.encode_cell({r:R, c:C})];
                                if(cell && cell.v) rowText.push(String(cell.v).toUpperCase());
                            }
                            const rowStr = rowText.join(' ');
                            if (rowStr.includes('FARE CONTENT') && rowStr.includes('WC1')) {
                                isH71D = true;
                                break;
                            }
                        }

                        if (isH71D) {
                            resolve(parseH71D(workbook, file.name));
                        } else {
                            resolve(parseB8BL(workbook, file.name));
                        }
                    } catch (err) { console.error(err); reject(err); }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function parseH71D(workbook, fileName) {
            const ws = workbook.Sheets[workbook.SheetNames[0]];
            // H71D Header is at Row 4 (index 3), data starts Row 5
            const raw = XLSX.utils.sheet_to_json(ws, { range: 3, defval: "" });
            
            const processed = raw.map((row, idx) => {
                // Parse WC1: "- 6% then + 5" or "+ 500"
                const wc1 = String(row['WC1'] || '');
                let comm = '0%';
                let fee = '';
                
                if (wc1.toLowerCase().includes('then')) {
                    const parts = wc1.split(/then/i);
                    // Part 0 is commission usually "- 6%"
                    let commPart = parts[0].replace(/-/g, '').trim(); // Remove minus
                    if(commPart.includes('%')) comm = commPart;
                    
                    // Part 1 is fee usually "+ 5"
                    let feePart = parts[1].replace(/\+/g, '').trim();
                    if(feePart) fee = feePart + " HKD";
                } else {
                    // Single value like "+ 500" (Fee) or "- 6%" (Comm)
                    if (wc1.includes('%')) {
                        comm = wc1.replace(/-/g, '').trim();
                    } else if (wc1.includes('+')) {
                        fee = wc1.replace(/\+/g, '').trim() + " HKD";
                    } else {
                         // Fallback for just number
                         if(wc1 && !isNaN(parseFloat(wc1))) fee = wc1 + " HKD"; 
                    }
                }
                
                // Add HKG/SOTO logic
                const cat = (row['Category'] || '').toUpperCase();
                let displayCat = cat;
                if(cat.includes('HKG')) displayCat = 'EX-HKG';
                
                return {
                    id: idx,
                    airline: row['Airline'],
                    category: displayCat,
                    fareType: row['Fare Type'],
                    content: row['Fare Content'],
                    extra: row['Extra Offer'],
                    commDisplay: comm,
                    feeDisplay: fee
                };
            });
            
            return { type: 'H71D', data: processed, pccSuggestion: 'H71D' };
        }

        function parseB8BL(workbook, fileName) {
            const result = { type: 'B8BL', master: [], summary: [], details: {}, pccSuggestion: 'B8BL' };
            const match = fileName.match(/([A-Z0-9]{4})/);
            if(match) result.pccSuggestion = match[1];

            workbook.SheetNames.forEach(name => {
                const ws = workbook.Sheets[name];
                const lower = name.toLowerCase();
                if(lower.includes('master')) {
                    // Try to find header row for master
                    const json = XLSX.utils.sheet_to_json(ws, {header:1});
                    let headerRow = 0;
                    for(let i=0; i<json.length; i++) {
                        const rowStr = json[i].join(' ').toUpperCase();
                        if(rowStr.includes('AIRLINE') && rowStr.includes('COMMISSION')) {
                            headerRow = i;
                            break;
                        }
                    }
                    result.master = XLSX.utils.sheet_to_json(ws, {range: headerRow});
                } else if(lower.includes('summary')) {
                     result.summary = XLSX.utils.sheet_to_json(ws);
                } else if(!lower.includes('dashboard')) {
                    result.details[name] = XLSX.utils.sheet_to_json(ws, {header:1});
                }
            });
            
            // Enrich
            if(result.master && result.summary) {
                result.master.forEach(m => {
                    const mAl = (m['Airline']||'').toUpperCase();
                    const sItem = result.summary.find(s => (s['Sheet Name']||'').toUpperCase().includes(mAl));
                    if(sItem) {
                        m._sheetName = sItem['Sheet Name'];
                        m._code = sItem['Airline Code'];
                    }
                });
            }
            return result;
        }

        // --- DB Ops ---
        async function savePCC(id, res) {
            const tx = db.transaction(['datasets'], 'readwrite');
            tx.objectStore('datasets').put({
                id: id, type: res.type, updated: new Date().toISOString(),
                recordCount: res.type==='H71D' ? res.data.length : res.master.length,
                data: res
            });
            return new Promise(r => tx.oncomplete = r);
        }

        async function refreshSidebar() {
            const tx = db.transaction(['datasets'], 'readonly');
            tx.objectStore('datasets').getAll().onsuccess = (e) => {
                const list = e.target.result.sort((a,b) => new Date(b.updated) - new Date(a.updated));
                state.allDatasets = list;
                const ul = document.getElementById('pccList');
                ul.innerHTML = '';
                list.forEach(d => {
                    const li = document.createElement('li');
                    li.className = `pcc-item ${state.currentPCC===d.id ? 'active' : ''}`;
                    li.innerHTML = `
                        <div class="pcc-info"><span class="pcc-name">${d.id}</span></div>
                        <div class="pcc-stats">
                            <span class="badge-type ${d.type}">${d.type}</span>
                            <span>${d.recordCount} Rules</span>
                        </div>
                    `;
                    li.onclick = () => loadDataset(d.id);
                    ul.appendChild(li);
                });
            };
        }

        async function loadDataset(id) {
            state.currentPCC = id;
            const tx = db.transaction(['datasets'], 'readonly');
            tx.objectStore('datasets').get(id).onsuccess = (e) => {
                const rec = e.target.result;
                state.currentType = rec.type;
                if(rec.type === 'H71D') {
                    state.h71dData = rec.data.data;
                    document.body.classList.add('mode-h71d');
                } else {
                    state.masterData = rec.data.master;
                    state.detailsMap = rec.data.details;
                    document.body.classList.remove('mode-h71d');
                }
                refreshSidebar();
                handleSearch(); // Refresh results
            };
        }

        // --- Search ---
        function handleSearch() {
            const q = document.getElementById('inpAirline').value.toUpperCase().trim();
            const resArea = document.getElementById('resultsArea');
            let results = [];

            if (state.currentType === 'H71D') {
                results = state.h71dData.filter(r => {
                    if(!q) return true;
                    const txt = (r.airline + r.content + r.category).toUpperCase();
                    return txt.includes(q);
                });
                renderH71D(results, resArea);
            } else {
                // B8BL Search
                results = state.masterData.filter(r => {
                    if(!q) return true;
                    const txt = (r['Airline'] + (r._sheetName||'') + (r._code||'')).toUpperCase();
                    return txt.includes(q);
                });
                renderB8BL(results, resArea);
            }
            
            document.getElementById('resultsHeader').classList.remove('hidden');
            document.getElementById('resCount').innerText = results.length;
        }

        function renderH71D(list, container) {
            container.innerHTML = '';
            list.slice(0, 100).forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                
                let tagClass = 'tag-other';
                if(item.category.includes('HKG')) tagClass = 'tag-hkg';
                if(item.category.includes('SOTO')) tagClass = 'tag-soto';
                
                const cnName = AIRLINE_CN_MAP[item.airline] || item.airline;
                
                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-airline">${cnName}</span>
                        <span class="h71d-tag ${tagClass}">${item.category}</span>
                    </div>
                    <div class="card-body">
                        <div class="h71d-content-box">
                            <div class="h71d-content-text">${item.content}</div>
                            ${item.extra ? `<div class="h71d-extra">EXTRA: ${item.extra}</div>` : ''}
                        </div>
                        <div class="commission-box">
                            <div class="h71d-comm-row" style="width:100%">
                                <span class="comm-value">${item.commDisplay}</span>
                                ${item.feeDisplay ? `<span class="h71d-fee-pill">+ ${item.feeDisplay} Fee</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="card-footer" style="justify-content:space-between">
                         <span style="font-size:0.75rem; color:#6b7280;">Type: ${item.fareType}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderB8BL(list, container) {
            container.innerHTML = '';
            list.slice(0, 100).forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const title = item._sheetName || item.Airline;
                let comm = item['Commission rate Adult %'] || '0%';
                if(!comm.includes('%')) comm += '%'; // Basic fix
                
                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-airline">${title}</span>
                    </div>
                    <div class="card-body">
                        <div class="data-row"><span class="data-label">Route</span><span class="data-value value-highlight">${item.Origin||'ALL'} ‚ûù ${item.Destination||'ALL'}</span></div>
                        <div class="data-row"><span class="data-label">Cabin</span><span class="data-value">${item.Cabin||'ALL'}</span></div>
                        <div class="commission-box">
                             <span class="comm-label">Commission</span>
                             <span class="comm-value">${comm}</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-sm btn-detail-hl" onclick='openDetailB8BL(${JSON.stringify(item).replace(/'/g, "&#39;")})'>Details / ËØ¶ÊÉÖ</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- Details Logic ---
        window.openDetailB8BL = function(item) {
            const pcc = state.currentPCC;
            const sheet = item._sheetName;
            document.getElementById('panelTitle').innerText = `${sheet || item.Airline} (${pcc})`;
            
            let html = '<p>No details found.</p>';
            if (sheet && state.detailsMap[sheet]) {
                const rows = state.detailsMap[sheet];
                html = '<div class="detail-section"><table class="info-table">';
                rows.forEach(r => {
                    html += '<tr>' + r.map(c => `<td>${c}</td>`).join('') + '</tr>';
                });
                html += '</table></div>';
            }
            document.getElementById('panelBody').innerHTML = html;
            document.getElementById('detailPanel').classList.add('open');
            document.getElementById('overlay').classList.add('open');
        };

        // --- Core Events ---
        document.getElementById('uploadExcel').addEventListener('change', async (e) => {
            const btn = document.querySelector('label[for="uploadExcel"]');
            const orig = btn.innerHTML;
            btn.innerHTML = 'Parsing...';
            try {
                if(!e.target.files[0]) return;
                const res = await parseExcelFile(e.target.files[0]);
                const id = prompt(`Enter Name for ${res.type} file:`, res.pccSuggestion);
                if(id) {
                    await savePCC(id.toUpperCase(), res);
                    await refreshSidebar();
                    await loadDataset(id.toUpperCase());
                }
            } catch(err) { alert("Error: "+err.message); }
            btn.innerHTML = orig;
            e.target.value = '';
        });

        document.getElementById('btnSearch').onclick = handleSearch;
        document.getElementById('inpAirline').onkeypress = (e) => e.key==='Enter' && handleSearch();
        document.getElementById('btnRefreshDB').onclick = refreshSidebar;
        window.closePanel = (id) => { document.getElementById(id).classList.remove('open'); document.getElementById('overlay').classList.remove('open'); };
        window.closeAllPanels = () => closePanel('detailPanel') || closePanel('canvasPanel');

        initDB().then(refreshSidebar);
    </script>
</body>
</html>
