<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Commission Quick Viewer v4.3 (Code Search Fix)</title>
    
    <!-- SheetJS with reliable fallback -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        if (typeof XLSX === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');
        }
    </script>
    
    <style>
        /* Base Styles */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-app: #f3f4f6;
            --bg-sidebar: #111827;
            --text-sidebar: #e5e7eb;
            --border: #e5e7eb;
            --white: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-app); color: var(--text-main); height: 100vh; overflow: hidden; }

        .app-container { display: flex; height: 100%; width: 100%; position: relative; }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); color: var(--text-sidebar); display: flex; flex-direction: column; padding: 1.25rem; flex-shrink: 0; border-right: 1px solid #374151; }
        .brand { margin-bottom: 2rem; display: flex; align-items: center; justify-content: space-between; }
        .brand h2 { margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--white); }
        .badge { background: var(--success); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }

        .sidebar-section { margin-bottom: 2rem; flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .sidebar h3 { font-size: 0.8rem; text-transform: uppercase; color: #9ca3af; margin: 0; letter-spacing: 0.05em; }
        
        .pcc-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .pcc-item { padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; background: #1f2937; cursor: pointer; transition: all 0.2s; position: relative; border-left: 3px solid transparent; }
        .pcc-item:hover { background: #374151; }
        .pcc-item.active { background: #374151; border-left-color: var(--primary); }
        .pcc-info { display: flex; justify-content: space-between; align-items: baseline; }
        .pcc-name { font-weight: bold; font-size: 1rem; color: var(--white); }
        .pcc-stats { font-size: 0.75rem; color: #9ca3af; margin-top: 4px; display: flex; gap: 6px; align-items: center; }
        .badge-type { font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; border: 1px solid #4b5563; }
        
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-sm { padding: 0.35rem 0.75rem; font-size: 0.8rem; }
        .btn-outline { background: transparent; border: 1px solid #4b5563; color: var(--text-sidebar); }
        .btn-outline:hover { border-color: var(--white); color: var(--white); }
        .btn-block { width: 100%; }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; background: #f9fafb; }

        .search-header { background: var(--white); padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 10; }
        .search-row { display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 0.75rem; }
        .search-row.secondary { margin-bottom: 0; align-items: center; justify-content: space-between; }
        
        .input-group { display: flex; flex-direction: column; }
        .flex-2 { flex: 2; } .flex-1 { flex: 1; }
        .input-group label { font-size: 0.75rem; font-weight: 600; margin-bottom: 0.35rem; color: var(--text-sub); text-transform: uppercase; }
        .input-group input { padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; }

        .advanced-details { flex: 1; }
        .advanced-details summary { cursor: pointer; font-size: 0.85rem; color: var(--primary); font-weight: 500; user-select: none; }
        .advanced-filters { display: flex; gap: 1rem; margin-top: 0.75rem; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; flex-wrap: wrap; }
        .advanced-filters input { flex: 1; min-width: 120px; padding: 0.4rem; font-size: 0.85rem; }

        /* Mode Visibility */
        body:not(.mode-h71d) .h71d-only { display: none !important; }
        body.mode-h71d .b8bl-only { display: none !important; }

        /* Results */
        .results-info { padding: 0.5rem 1.5rem; background: #eefff6; color: #065f46; font-size: 0.85rem; border-bottom: 1px solid #d1fae5; }
        .results-grid { padding: 1.5rem; overflow-y: auto; flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1rem; align-content: start; }

        /* Cards */
        .card { background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; flex-direction: column; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; background: #fff; border-radius: 8px 8px 0 0; }
        .card-airline { font-weight: 800; font-size: 1.15rem; color: var(--text-main); line-height: 1.3; display: block; }
        .card-pcc-tag { font-size: 0.7rem; background: #e5e7eb; padding: 2px 6px; border-radius: 4px; vertical-align: middle; color: #4b5563; font-weight: normal; margin-left: 6px; }
        .card-dates { font-size: 0.75rem; color: var(--text-sub); text-align: right; background: #f9fafb; padding: 4px 8px; border-radius: 4px; border: 1px solid #e5e7eb; }

        .card-body { padding: 1rem; flex: 1; font-size: 0.9rem; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: baseline; }
        .data-label { color: var(--text-sub); font-size: 0.8rem; flex: 1; }
        .data-value { font-weight: 500; text-align: right; flex: 2; word-break: break-word; }
        .value-highlight { color: var(--primary); font-weight: 600; }
        
        .commission-box { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border); display: flex; justify-content: space-between; align-items: center; }
        .comm-label { font-size: 0.8rem; font-weight: 600; color: var(--text-sub); text-transform: uppercase; }
        .comm-value { font-size: 1.4rem; font-weight: 800; color: var(--success); }

        .card-footer { padding: 0.75rem 1rem; background: #f9fafb; border-top: 1px solid var(--border); border-radius: 0 0 8px 8px; display: flex; gap: 0.75rem; }
        
        /* H71D Styles */
        .h71d-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 8px; }
        .tag-hkg { background: #ede9fe; color: #7c3aed; }
        .tag-soto { background: #fce7f3; color: #db2777; }
        .tag-other { background: #f3f4f6; color: #6b7280; }
        .h71d-content-box { margin-bottom: 1rem; font-family: monospace; font-size: 0.85rem; color: #4b5563; background: #f8fafc; padding: 0.5rem; border-radius: 4px; border: 1px solid #e5e7eb; white-space: pre-wrap; max-height: 100px; overflow-y: auto; }
        .h71d-fee { font-size: 0.85rem; background: #ecfdf5; color: #047857; padding: 2px 6px; border-radius: 4px; border: 1px solid #10b981; margin-left: 0.5rem; }

        /* Slide Panel */
        .slide-panel { position: absolute; top: 0; right: 0; bottom: 0; width: 600px; background: var(--white); box-shadow: -10px 0 25px rgba(0,0,0,0.15); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 100; display: flex; flex-direction: column; }
        .slide-panel.wide { width: 900px; }
        .slide-panel.open { transform: translateX(0); }
        .panel-header { padding: 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f9fafb; }
        .panel-content { padding: 1.5rem; overflow-y: auto; flex: 1; }
        .btn-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        /* Tables */
        .info-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .info-table th { background: #f9fafb; text-align: left; padding: 0.6rem 1rem; border-bottom: 1px solid var(--border); }
        .info-table td { padding: 0.6rem 1rem; border-bottom: 1px solid #e5e7eb; }
        
        /* Details Button Highlight */
        .btn-detail-hl { 
            background: linear-gradient(135deg, #f97316, #ea580c); 
            color: #ffffff !important; 
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(234, 88, 12, 0.3);
        }
        .btn-detail-hl:hover { background: linear-gradient(135deg, #ea580c, #c2410c); }

        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 50; display: none; }
        .overlay.open { display: block; }
        .hidden { display: none !important; }
        .empty-state { text-align: center; margin-top: 4rem; color: #9ca3af; }
        .empty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #374151; padding: 1rem; max-height: 250px; }
            .search-row.primary { flex-direction: column; align-items: stretch; gap: 0.5rem; }
            .slide-panel { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <h2>Commission v4.3</h2>
                <span class="badge">Fixed</span>
            </div>
            
            <div class="sidebar-section">
                <div class="section-header">
                    <h3>Datasets</h3>
                    <button id="btnRefreshDB" class="btn-icon" title="Refresh">‚Üª</button>
                </div>
                <div class="file-input-wrapper">
                    <label for="uploadExcel" class="btn btn-primary btn-block">
                        <span class="icon">+</span> Upload File
                    </label>
                    <input type="file" id="uploadExcel" accept=".xlsx, .xls" hidden>
                </div>
                <ul id="pccList" class="pcc-list">
                    <li class="loading-text" style="color:#aaa; text-align:center;">Initializing DB...</li>
                </ul>
            </div>
            
            <div class="sidebar-section bottom">
                <div class="btn-group" style="display:flex; gap:0.5rem;">
                    <button id="btnExportData" class="btn btn-sm btn-outline">Export</button>
                    <button id="btnImportData" class="btn btn-sm btn-outline">Import</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="search-header">
                <div class="search-row primary">
                    <div class="input-group flex-2">
                        <label id="lblAirline">Airline / Ëà™Âè∏</label>
                        <input type="text" id="inpAirline" placeholder="Code (e.g. UA) or Name...">
                    </div>
                    <div class="input-group flex-1 b8bl-only">
                        <label>Origin</label>
                        <input type="text" id="inpOrigin" placeholder="YYZ, CA">
                    </div>
                    <div class="input-group flex-1 b8bl-only">
                        <label>Dest</label>
                        <input type="text" id="inpDest" placeholder="LHR, GB">
                    </div>
                    <div class="input-group flex-1 b8bl-only">
                        <label>Date</label>
                        <input type="date" id="inpDate">
                    </div>
                    <div class="input-group action">
                        <button id="btnSearch" class="btn btn-primary btn-lg">Search</button>
                    </div>
                </div>
                
                <div class="search-row secondary">
                    <div class="b8bl-only" style="flex:1;">
                        <details class="advanced-details">
                            <summary>Advanced Filters</summary>
                            <div class="advanced-filters">
                                <input type="text" id="inpCabin" placeholder="Cabin">
                                <input type="text" id="inpRBD" placeholder="RBD">
                                <input type="text" id="inpTourCode" placeholder="Tour Code">
                                <input type="text" id="inpFareClass" placeholder="Fare Class">
                            </div>
                        </details>
                    </div>
                    <div class="h71d-only" style="flex:1; font-size:0.85rem; color:#6b7280;">
                        <i>* H71D Mode: Search by text content enabled</i>
                    </div>
                    <div class="toggle-group">
                        <label class="switch-label">
                            <input type="checkbox" id="chkCurrentPCC" checked> 
                            <span>Current DB Only</span>
                        </label>
                    </div>
                </div>
            </header>

            <div id="resultsHeader" class="results-info hidden">Found <span id="resCount">0</span> rules.</div>
            <div id="resultsArea" class="results-grid">
                <div class="empty-state">
                    <div class="empty-icon">üìÇ</div>
                    <h3>Ready</h3>
                    <p>Select a dataset or upload a file.</p>
                </div>
            </div>
        </main>

        <!-- Slide Panels -->
        <div id="detailPanel" class="slide-panel">
            <div class="panel-header">
                <h2 id="panelTitle">Details</h2>
                <button class="btn-close" onclick="closePanel('detailPanel')">&times;</button>
            </div>
            <div class="panel-content" id="panelBody"></div>
        </div>
        
        <div id="canvasPanel" class="slide-panel wide">
            <div class="panel-header">
                <h2>Checklist</h2>
                <button class="btn-close" onclick="closePanel('canvasPanel')">&times;</button>
            </div>
            <div class="panel-content center-content">
                <div class="canvas-wrapper" style="border:1px solid #eee; padding:1rem; display:flex; justify-content:center;">
                    <canvas id="previewCanvas"></canvas>
                </div>
                <div style="text-align:center; margin-top:1rem;">
                    <button id="btnDownloadCanvas" class="btn btn-primary">Download Image</button>
                </div>
            </div>
        </div>

        <div id="overlay" class="overlay" onclick="closeAllPanels()"></div>
    </div>

    <!-- Logic -->
    <script>
        const DB_NAME='CommissionViewerV4_3'; const DB_VERSION=1;
        
        // Comprehensive Mapping: Code -> Name (and vice versa via lookup)
        const AIRLINE_CN_MAP = {
            "3U":"Sichuan AirlinesÂõõÂ∑ùËà™Á©∫", "8M":"Myanmar Airways", "AC":"Air CanadaÂä†ÊãøÂ§ßËà™Á©∫",
            "CI":"China Airlines‰∏≠ÂçéËà™Á©∫", "CX":"Cathay PacificÂõΩÊ≥∞Ëà™Á©∫", "CZ":"China SouthernÂçóÊñπËà™Á©∫",
            "EK":"EmiratesÈòøËÅîÈÖãËà™Á©∫", "ET":"Ethiopian Airlines", "HU":"Hainan AirlinesÊµ∑ÂçóËà™Á©∫",
            "JL":"Japan AirlinesÊó•Êú¨Ëà™Á©∫", "KE":"Korean AirÂ§ßÈü©Ëà™Á©∫", "MH":"Malaysia Airlines",
            "MU":"China Eastern‰∏úÊñπËà™Á©∫", "NH":"ANAÂÖ®Êó•Á©∫", "NZ":"Air New Zealand",
            "OZ":"Asiana AirlinesÈü©‰∫öËà™Á©∫", "PR":"Philippine Airlines", "QF":"Qantas",
            "QR":"Qatar Airways", "SQ":"Singapore Airlines", "TK":"Turkish Airlines",
            "UA":"United AirlinesÁæéËÅîËà™", "VS":"Virgin Atlantic", "WS":"WestJet", "YP":"Air Premia",
            "DL":"Delta Air Lines", "AA":"American Airlines", "AF":"Air France", "KL":"KLM",
            "LH":"Lufthansa", "LX":"Swiss", "OS":"Austrian", "SN":"Brussels Airlines",
            "BR":"EVA Air", "MF":"Xiamen Airlines", "B6":"JetBlue", "AS":"Alaska Airlines"
        };
        
        let db;
        let state = { currentPCC:null, currentType:'B8BL', allDatasets:[], masterData:[], h71dData:[], summaryData:[], detailsMap:{}, airlineCodeMap:{} };

        // --- Init DB ---
        function initDB() {
            return new Promise((resolve,reject)=>{
                const req=indexedDB.open(DB_NAME,DB_VERSION);
                req.onupgradeneeded=(e)=>{
                    db=e.target.result;
                    if(!db.objectStoreNames.contains('datasets')) db.createObjectStore('datasets',{keyPath:'id'});
                    if(!db.objectStoreNames.contains('notes')) db.createObjectStore('notes',{keyPath:'id'});
                };
                req.onsuccess=(e)=>{db=e.target.result; resolve(db);};
                req.onerror=(e)=>reject(e);
            });
        }

        // --- Robust Parser ---
        function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Smart Detection
                        const firstSheetName = workbook.SheetNames[0];
                        const ws = workbook.Sheets[firstSheetName];
                        
                        let isH71D = false;
                        let h71dHeaderRow = 0;
                        const range = XLSX.utils.decode_range(ws['!ref'] || "A1:G20");
                        for (let R = 0; R <= Math.min(range.e.r, 20); ++R) {
                            const rowVals = [];
                            for(let C = range.s.c; C <= range.e.c; ++C) {
                                const cell = ws[XLSX.utils.encode_cell({r:R, c:C})];
                                if(cell && cell.v) rowVals.push(String(cell.v).toUpperCase());
                            }
                            const rowStr = rowVals.join('|');
                            if ((rowStr.includes('FARE CONTENT') || rowStr.includes('FARE TYPE')) && 
                                (rowStr.includes('WC1') || rowStr.includes('COMMISSION'))) {
                                isH71D = true;
                                h71dHeaderRow = R;
                                break;
                            }
                        }

                        if (isH71D) {
                            resolve(parseH71D(workbook, file.name, h71dHeaderRow));
                        } else {
                            resolve(parseB8BL(workbook, file.name));
                        }
                    } catch (err) { console.error("Parse Error:", err); reject(err); }
                };
                reader.onerror = (err) => reject(new Error("File read failed"));
                reader.readAsArrayBuffer(file);
            });
        }

        function parseH71D(workbook, fileName, headerRowIndex) {
            const ws = workbook.Sheets[workbook.SheetNames[0]];
            const raw = XLSX.utils.sheet_to_json(ws, { range: headerRowIndex, defval: "" });
            
            const processed = raw.map((row, idx) => {
                // Parse WC1: "- 6% then + 5"
                const wc1 = String(row['WC1'] || row['Commission'] || '');
                let comm = '0%';
                let fee = '';
                
                if (wc1.toLowerCase().includes('then')) {
                    const parts = wc1.split(/then/i);
                    let commPart = parts[0].replace(/-/g, '').trim();
                    if(commPart.includes('%')) comm = commPart;
                    let feePart = parts[1].replace(/\+/g, '').trim();
                    if(feePart) fee = feePart + " HKD";
                } else if (wc1.includes('+') && !wc1.includes('%')) {
                    fee = wc1.replace(/\+/g, '').trim() + " HKD";
                } else if (wc1.includes('%')) {
                    comm = wc1.replace(/-/g, '').trim();
                } else {
                     if(wc1 && !isNaN(parseFloat(wc1))) fee = wc1 + " HKD"; 
                }

                const code = (row['Airline'] || '').trim().toUpperCase();
                const fullName = AIRLINE_CN_MAP[code] || code;
                const cat = (row['Category'] || '').toUpperCase();
                let displayCat = cat;
                if(cat.includes('HKG')) displayCat = 'EX-HKG';
                else if(cat.includes('SOTO')) displayCat = 'SOTO';

                return {
                    id: idx,
                    airlineCode: code,
                    airlineName: fullName,
                    category: displayCat,
                    fareType: row['Fare Type'],
                    content: row['Fare Content'] || '',
                    extra: row['Extra Offer'],
                    commDisplay: comm,
                    feeDisplay: fee
                };
            });
            return { type: 'H71D', data: processed, pccSuggestion: 'H71D' };
        }

        function parseB8BL(workbook, fileName) {
            const result = { type: 'B8BL', master: [], summary: [], details: {}, pccSuggestion: 'B8BL' };
            const match = fileName.match(/([A-Z0-9]{4})/);
            if(match) result.pccSuggestion = match[1];

            workbook.SheetNames.forEach(name => {
                const ws = workbook.Sheets[name];
                const lower = name.toLowerCase();
                if(lower.includes('master')) {
                    const json = XLSX.utils.sheet_to_json(ws, {header:1});
                    let headerRow = 0;
                    for(let i=0; i<Math.min(json.length, 20); i++) {
                        const str = (json[i]||[]).join(' ').toUpperCase();
                        if(str.includes('COMMISSION') && str.includes('AIRLINE')) {
                            headerRow = i; break;
                        }
                    }
                    result.master = XLSX.utils.sheet_to_json(ws, {range: headerRow});
                } else if(lower.includes('summary')) {
                     result.summary = XLSX.utils.sheet_to_json(ws);
                } else if(!lower.includes('dashboard')) {
                    result.details[name] = XLSX.utils.sheet_to_json(ws, {header:1});
                }
            });
            
            enrichB8BLMaster(result.master, result.summary);
            return result;
        }

        // AGGRESSIVE ENRICHMENT for Code Search
        function enrichB8BLMaster(master, summary) {
            if (!master) return;
            master.forEach(row => {
                const mAl = (row['Airline']||'').trim();
                const mAlUpper = mAl.toUpperCase();
                
                // 1. Try to find Sheet Name from Summary
                let matchedSummary = null;
                if (summary) {
                    matchedSummary = summary.find(s => (s['Sheet Name']||'').toUpperCase().includes(mAlUpper));
                }
                
                if (matchedSummary) {
                    row._sheetName = matchedSummary['Sheet Name'];
                    row._airlineCode = matchedSummary['Airline Code'];
                }
                
                // 2. If no code yet, try to derive from AIRLINE_CN_MAP (Reverse Lookup)
                if (!row._airlineCode) {
                    // Try to find if 'United Airlines' is in value of 'UA'
                    for (const [code, name] of Object.entries(AIRLINE_CN_MAP)) {
                        const nameUpper = name.toUpperCase();
                        if (nameUpper.includes(mAlUpper) || mAlUpper.includes(nameUpper)) {
                            row._airlineCode = code;
                            break;
                        }
                        // Check if just the name part matches e.g. "United Airlines" inside "United AirlinesÁæéËÅîËà™"
                        const cleanName = nameUpper.replace(/[^\x00-\x7F]/g, "").trim(); // Remove Chinese
                        if (cleanName && (mAlUpper.includes(cleanName) || cleanName.includes(mAlUpper))) {
                             row._airlineCode = code;
                             break;
                        }
                    }
                }
                
                // 3. Fallback: Check if Validating Carrier col exists
                if (!row._airlineCode && row['Validating Carrier']) {
                    row._airlineCode = row['Validating Carrier'];
                }
            });
        }

        // --- Database & UI Ops ---
        async function savePCC(id, res) {
            const tx = db.transaction(['datasets'], 'readwrite');
            tx.objectStore('datasets').put({
                id: id, type: res.type, updated: new Date().toISOString(),
                recordCount: res.type==='H71D' ? res.data.length : res.master.length,
                data: res
            });
            return new Promise(r => tx.oncomplete = r);
        }

        async function refreshSidebar() {
            const tx = db.transaction(['datasets'], 'readonly');
            tx.objectStore('datasets').getAll().onsuccess = (e) => {
                const list = e.target.result.sort((a,b) => new Date(b.updated) - new Date(a.updated));
                state.allDatasets = list;
                const ul = document.getElementById('pccList');
                ul.innerHTML = '';
                list.forEach(d => {
                    const li = document.createElement('li');
                    li.className = `pcc-item ${state.currentPCC===d.id ? 'active' : ''}`;
                    li.innerHTML = `
                        <div class="pcc-info"><span class="pcc-name">${d.id}</span></div>
                        <div class="pcc-stats">
                            <span class="badge-type ${d.type}">${d.type}</span>
                            <span>${d.recordCount} Rows</span>
                        </div>`;
                    li.onclick = () => loadDataset(d.id);
                    ul.appendChild(li);
                });
            };
        }

        async function loadDataset(id) {
            state.currentPCC = id;
            const tx = db.transaction(['datasets'], 'readonly');
            tx.objectStore('datasets').get(id).onsuccess = (e) => {
                const rec = e.target.result;
                state.currentType = rec.type;
                if(rec.type === 'H71D') {
                    state.h71dData = rec.data.data;
                    document.body.classList.add('mode-h71d');
                } else {
                    state.masterData = rec.data.master;
                    state.detailsMap = rec.data.details;
                    document.body.classList.remove('mode-h71d');
                }
                refreshSidebar();
                handleSearch();
            };
        }

        // --- Search ---
        function handleSearch() {
            const q = document.getElementById('inpAirline').value.toUpperCase().trim();
            const resArea = document.getElementById('resultsArea');
            let results = [];

            if (state.currentType === 'H71D') {
                results = state.h71dData.filter(r => {
                    if(!q) return true;
                    // H71D Search: Code, Name, Content
                    const txt = (r.airlineCode + r.airlineName + r.content + r.category).toUpperCase();
                    return txt.includes(q);
                });
                renderH71D(results, resArea);
            } else {
                // B8BL Search: Code, Name, Sheet Name
                results = state.masterData.filter(r => {
                    if(!q) return true;
                    
                    const code = (r._airlineCode || r['Validating Carrier'] || '').toUpperCase();
                    const name = (r['Airline'] || '').toUpperCase();
                    const sheet = (r._sheetName || '').toUpperCase();
                    
                    // 1. Direct Code match (e.g. "UA")
                    if (code === q || code.includes(q)) return true;
                    
                    // 2. Direct Name match
                    if (name.includes(q)) return true;
                    
                    // 3. Mapped match (Type "UA" -> Match "United")
                    if (AIRLINE_CN_MAP[q]) {
                        const fullMapName = AIRLINE_CN_MAP[q].toUpperCase();
                        if (name.includes(fullMapName) || fullMapName.includes(name)) return true;
                    }
                    
                    // 4. Reverse Mapped match (Type "United" -> Match "UA" code)
                    // (Already handled by enrichment, if row has _airlineCode, simple includes works)
                    
                    return sheet.includes(q);
                });
                renderB8BL(results, resArea);
            }
            
            document.getElementById('resultsHeader').classList.remove('hidden');
            document.getElementById('resCount').innerText = results.length;
        }

        function renderH71D(list, container) {
            container.innerHTML = '';
            list.slice(0, 100).forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                let tagClass = '';
                if(item.category.includes('HKG')) tagClass = 'tag-hkg';
                if(item.category.includes('SOTO')) tagClass = 'tag-soto';
                
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <span class="card-airline">${item.airlineName}</span>
                            ${tagClass ? `<span class="h71d-tag ${tagClass}">${item.category}</span>` : ''}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="h71d-content-box">${item.content}</div>
                        <div class="commission-box">
                            <span class="comm-label">Commission</span>
                            <div style="display:flex; align-items:center;">
                                <span class="comm-value">${item.commDisplay}</span>
                                ${item.feeDisplay ? `<span class="h71d-fee">+ ${item.feeDisplay}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <span style="font-size:0.75rem; color:#6b7280;">Type: ${item.fareType}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderB8BL(list, container) {
            container.innerHTML = '';
            list.slice(0, 100).forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                
                // Display Title Logic
                let title = item._sheetName;
                const code = item._airlineCode || item['Validating Carrier'];
                const name = item['Airline'];
                
                if (!title) {
                    if (code) title = `${code} - ${name}`;
                    else title = name;
                }

                let comm = item['Commission rate Adult %'] || '0%';
                if(!comm.includes('%')) comm += '%';

                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-airline">${title}</span>
                    </div>
                    <div class="card-body">
                        <div class="data-row"><span class="data-label">Route</span><span class="data-value value-highlight">${item.Origin||'ALL'} ‚ûù ${item.Destination||'ALL'}</span></div>
                        <div class="data-row"><span class="data-label">Cabin</span><span class="data-value">${item.Cabin||'ALL'}</span></div>
                        <div class="commission-box">
                             <span class="comm-label">Commission</span>
                             <span class="comm-value">${comm}</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-sm btn-detail-hl" style="width:100%" onclick='openDetailB8BL(${JSON.stringify(item).replace(/'/g, "&#39;")})'>Details / ËØ¶ÊÉÖ</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.openDetailB8BL = function(item) {
            const sheet = item._sheetName;
            document.getElementById('panelTitle').innerText = `${sheet || item.Airline}`;
            let html = '<p style="padding:1rem; color:#666">No additional details found.</p>';
            
            // Try match
            let rows = null;
            if (sheet && state.detailsMap[sheet]) rows = state.detailsMap[sheet];
            else {
                // Fallback search in details keys
                const key = Object.keys(state.detailsMap).find(k => k.includes(item.Airline));
                if(key) rows = state.detailsMap[key];
            }

            if (rows) {
                html = '<div class="detail-section"><table class="info-table">';
                rows.forEach(r => {
                    html += '<tr>' + r.map(c => `<td>${c}</td>`).join('') + '</tr>';
                });
                html += '</table></div>';
            }
            document.getElementById('panelBody').innerHTML = html;
            document.getElementById('detailPanel').classList.add('open');
            document.getElementById('overlay').classList.add('open');
        };

        // --- Listeners ---
        document.getElementById('uploadExcel').addEventListener('change', async (e) => {
            const btn = document.querySelector('label[for="uploadExcel"]');
            const orig = btn.innerHTML;
            btn.innerHTML = 'Analyzing...';
            try {
                if(!e.target.files[0]) return;
                const res = await parseExcelFile(e.target.files[0]);
                const id = prompt(`Enter ID for ${res.type} file:`, res.pccSuggestion);
                if(id) {
                    await savePCC(id.toUpperCase(), res);
                    await refreshSidebar();
                    await loadDataset(id.toUpperCase());
                }
            } catch(err) { alert("Upload Failed: "+err.message); }
            btn.innerHTML = orig;
            e.target.value = '';
        });

        document.getElementById('btnSearch').onclick = handleSearch;
        document.getElementById('inpAirline').onkeypress = (e) => e.key==='Enter' && handleSearch();
        document.getElementById('btnRefreshDB').onclick = refreshSidebar;
        window.closePanel = (id) => { document.getElementById(id).classList.remove('open'); document.getElementById('overlay').classList.remove('open'); };
        window.closeAllPanels = () => { closePanel('detailPanel'); closePanel('canvasPanel'); };

        initDB().then(refreshSidebar);
    </script>
</body>
</html>
